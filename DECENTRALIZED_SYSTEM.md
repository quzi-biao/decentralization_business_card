# 去中心化加密名片系统 - 实现文档

## 系统概述

这是一个基于端到端加密的去中心化名片交换系统，采用公私钥加密机制，确保用户数据隐私和安全。

## 核心特性

### ✅ 已实现功能

1. **身份管理**
   - 自动生成公私钥对
   - 去中心化身份标识 (DID)
   - 12词助记词备份
   - 安全的私钥存储

2. **加密机制**
   - AES-256 对称加密（数据加密）
   - 公钥加密（密钥交换）
   - 数字签名（数据完整性）
   - 混合加密方案

3. **名片交换**
   - 二维码生成与扫描
   - 公钥交换
   - 授权访问机制
   - 交换记录管理

4. **数据存储**
   - 加密数据本地存储（模拟 OSS）
   - 访问授权管理
   - 撤销机制
   - 数据哈希验证

5. **隐私保护**
   - 截屏保护提示
   - 访问权限控制
   - 数据加密存储
   - 撤销访问功能

## 技术架构

### 模块结构

```
src/
├── utils/
│   └── crypto.ts              # 加密工具（密钥生成、加密、签名）
├── services/
│   ├── identityService.ts     # 身份管理（DID、密钥存储）
│   └── storageService.ts      # 存储服务（加密上传下载）
├── store/
│   ├── useCardStore.ts        # 名片数据状态
│   └── useExchangeStore.ts    # 交换记录状态
└── screens/
    ├── InitScreen.tsx         # 初始化界面
    ├── HomeScreen.tsx         # 我的名片
    ├── ExchangeScreen.tsx     # 名片交换
    ├── CollectionScreen.tsx   # 名片收藏
    ├── AssistantScreen.tsx    # AI助手
    └── ProfileScreen.tsx      # 设置编辑
```

### 数据流程

#### 1. 初始化流程
```
用户首次打开应用
    ↓
生成 RSA 密钥对
    ↓
生成 DID (基于公钥)
    ↓
生成 12 词助记词
    ↓
安全存储私钥 (SecureStore)
    ↓
显示助记词供用户备份
```

#### 2. 名片上传流程
```
用户编辑名片数据
    ↓
生成随机 AES 密钥
    ↓
用 AES 加密名片 JSON
    ↓
用自己的公钥加密 AES 密钥
    ↓
生成数字签名
    ↓
上传到存储（AsyncStorage 模拟 OSS）
    ↓
生成二维码（包含 DID、公钥、存储地址）
```

#### 3. 名片交换流程
```
用户 A 展示二维码
    ↓
用户 B 扫描二维码
    ↓
B 获取 A 的 DID、公钥、存储地址
    ↓
B 创建授权：用 A 的公钥加密自己的 AES 密钥
    ↓
B 保存交换记录
    ↓
B 下载 A 的加密数据
    ↓
B 用授权中的密钥解密 A 的名片
    ↓
交换完成（双向进行）
```

#### 4. 查看名片流程
```
用户点击已交换的名片
    ↓
检查授权是否被撤销
    ↓
下载加密的名片数据
    ↓
获取访问授权
    ↓
用自己的私钥解密 AES 密钥
    ↓
用 AES 密钥解密名片数据
    ↓
显示名片详情（启用截屏保护）
```

#### 5. 撤销访问流程
```
用户选择撤销某人的访问
    ↓
删除授权记录
    ↓
添加到撤销列表
    ↓
对方下次访问时检查撤销列表
    ↓
拒绝访问并删除本地缓存
```

## 安全机制

### 1. 加密层级

- **第一层：数据加密**
  - 使用 AES-256-GCM 加密名片 JSON
  - 每个用户独立的 AES 密钥

- **第二层：密钥加密**
  - 用公钥加密 AES 密钥
  - 只有持有对应私钥的人能解密

- **第三层：签名验证**
  - 所有数据包含数字签名
  - 验证数据完整性和来源

### 2. 密钥管理

- **私钥存储**：使用 `expo-secure-store` 安全存储
- **助记词备份**：12 词助记词，用户手动备份
- **公钥分发**：通过二维码安全交换

### 3. 访问控制

- **授权机制**：显式授权才能访问
- **撤销功能**：可随时撤销访问权限
- **过期时间**：授权可设置有效期（默认1年）

### 4. 隐私保护

- **截屏保护**：查看他人名片时提示保护
- **数据隔离**：每个用户的数据独立加密
- **本地优先**：敏感数据优先本地存储

## 使用指南

### 首次使用

1. **创建身份**
   - 打开应用，点击"创建我的身份"
   - 系统自动生成密钥对和 DID

2. **备份助记词**
   - 抄写显示的 12 个词
   - 妥善保管，不要截屏或拍照
   - 这是恢复身份的唯一方式

3. **编辑名片**
   - 进入"设置"页面
   - 填写个人和企业信息
   - 系统自动加密并上传

### 交换名片

1. **展示二维码**
   - 进入"交换"页面
   - 选择"我的二维码"
   - 让对方扫描

2. **扫描对方二维码**
   - 进入"交换"页面
   - 选择"扫描名片"
   - 对准对方二维码
   - 系统自动完成交换

### 查看名片

1. **进入收藏**
   - 点击"收藏"页面
   - 查看已交换的名片列表

2. **查看详情**
   - 点击任意名片
   - 系统自动解密并显示
   - 启用截屏保护

3. **撤销访问**
   - 在名片列表中点击"撤销访问"
   - 对方将无法再查看您的名片

## 技术细节

### 加密算法

```typescript
// 密钥生成
const { publicKey, privateKey } = await generateKeyPair();

// AES 加密
const aesKey = generateAESKey();
const encrypted = encryptAES(JSON.stringify(data), aesKey);

// 公钥加密
const encryptedKey = encryptWithPublicKey(aesKey, publicKey);

// 签名
const signature = signData(encrypted, privateKey);
```

### 数据结构

```typescript
// 加密包
interface EncryptedPackage {
    did: string;              // 所有者 DID
    storageUrl: string;       // 存储地址
    encryptedData: string;    // AES 加密的数据
    encryptedKey: string;     // 公钥加密的 AES 密钥
    dataHash: string;         // 数据哈希
    signature: string;        // 数字签名
    version: string;          // 版本
    timestamp: number;        // 时间戳
}

// 访问授权
interface AccessGrant {
    granterDid: string;       // 授权者
    granteeDid: string;       // 被授权者
    granteePublicKey: string; // 被授权者公钥
    encryptedAESKey: string;  // 加密的 AES 密钥
    expiresAt: number;        // 过期时间
    signature: string;        // 签名
}
```

## 未来优化

### Phase 2: 生产环境部署

1. **真实 OSS 集成**
   - 集成阿里云 OSS / 腾讯云 COS
   - 实现客户端加密上传
   - 多云备份策略

2. **完整的 RSA 实现**
   - 使用标准 RSA-2048 或 ECC
   - 完整的签名验证算法
   - 证书链支持

3. **区块链集成**
   - DID 注册上链
   - 交换记录上链
   - 撤销列表上链

### Phase 3: 高级功能

1. **NFC 交换**
   - 近场通信支持
   - 无需扫码快速交换

2. **多设备同步**
   - 加密的云备份
   - 多设备密钥同步

3. **社交恢复**
   - 多签恢复机制
   - 信任网络

4. **企业版功能**
   - 团队管理
   - 权限分级
   - 审计日志

## 安全建议

### 用户须知

1. **助记词管理**
   - ✅ 抄写在纸上，存放在安全的地方
   - ❌ 不要截屏、拍照或存储在云端
   - ❌ 不要分享给任何人

2. **设备安全**
   - 使用设备锁屏密码
   - 定期更新系统
   - 不要 root/越狱设备

3. **交换安全**
   - 面对面交换最安全
   - 验证对方身份
   - 不要扫描不明来源的二维码

### 开发者须知

1. **密钥存储**
   - 私钥永不上传
   - 使用 SecureStore 存储
   - 考虑硬件加密

2. **网络通信**
   - 使用 HTTPS
   - 证书固定
   - 防止中间人攻击

3. **代码安全**
   - 代码混淆
   - 防止逆向工程
   - 定期安全审计

## 常见问题

### Q: 如果丢失手机怎么办？
A: 使用助记词在新设备上恢复身份。这就是为什么备份助记词非常重要。

### Q: 可以修改已交换的名片吗？
A: 可以。您修改名片后，对方下次同步时会获取最新版本。

### Q: 撤销访问后对方还能看到我的名片吗？
A: 不能。撤销后对方无法解密您的最新数据，本地缓存也会被清除。

### Q: 数据存储在哪里？
A: 当前版本存储在本地（模拟 OSS）。生产版本会存储在加密的云端（阿里云/腾讯云）。

### Q: 这个系统真的安全吗？
A: 采用了行业标准的加密算法和最佳实践。但任何系统都不是绝对安全的，用户需要妥善保管助记词和设备。

## 技术支持

如有问题或建议，请联系开发团队。

---

**版本**: 1.0.0  
**最后更新**: 2026-01-11  
**许可**: MIT
